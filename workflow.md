# 查询执行流程
接下来将以查询为例，详解整个查询操作的执行过程。所用到的查询语句是SELECT ID FROM STUDENTS WHERE (MATH_SCORE + ENGLISH_SCORE) / 2 >= 80，找出所有数学英语成绩平均起来大于等于80分得学生。

## 网络部分
![两个线程](./workflow-pic/two-thread.jpg)  
客户端把SQL语句发给服务端，服务端首先把SQL语句的字符串放入一个阻塞队列里面，工作线程会监听阻塞队列，如果队列为空则阻塞，直到队列里面有SQL字符串可以消费。接着工作线程把这条SQL语句取出。

## 生成解析树并做语义检查
接下来就是对SQL做词法分析和语法分析。词法分析得到的单词串是
Select identifier(ID) From identifier(STUDENTS) Where OpenBracket identifier(MATH_SCORE) PLUS CloseBracket DIV Integer(2) LE Integer(80)。
然后语法分析阶段把这个单词序列解析成下面的解析树。
![解析树](./workflow-pic/production-tree.jpg)  
接着会对解析树做语义检查。首先会从TableManager这个表管理对象中根据解析树用到的表，生成一个表信息的TableSet，接着解析树会使用TableSet的信息做语义检查。例如检查STUDENTS表是否存在，ID、MATH_SCORE、ENGLISH_SCORE这三个字段是否存在，还有后两个字段是否是可以用来做数学计算的类型。如果类型检查没通过则直接把错误消息发送给客户端。
![语义检查](./workflow-pic/production-tree.jpg)  

## 生成执行计划
接着解析树会被用于生成执行计划。首先执行计划生成器发现是查询操作，然后就生成了一个全表扫描迭代器。接着发现解析树种含有WHERE子句，就生成一个过滤迭代器，并把全表扫描迭代器和过滤迭代器拼装在一起。接着发现SELECT子句中不是选择所有字段，接着就根据需要投影的字段生成投影迭代器，并把所有迭代器拼装成一个整体。
![迭代器](./workflow-pic/iter.jpg)  

## 迭代器的运行
接着合成的三个迭代器会被运行。首先投影迭代器会被调用，然后它会去找过滤迭代器要数据，而过滤迭代器则会找全表扫描迭代器要数据。全表扫描的细节将在后面讲述，它扫到一个元组就会把它返回给过滤迭代器，过滤迭代器就做过滤操作，过滤操作会放在下节说明，如果该元组没有通过过滤，那么过滤迭代器会找全表扫描迭代器继续要数据，知道找到一个符合要求的数据为止，并把它返回给投影迭代器。投影迭代器把在得到的元组中找出ID这个字段的数据，然后把数据返回出去。
由于迭代器可以很好地做流式操作，所以迭代器生产了一部分数据的时候，就可以立刻把这部分数据通过网络发送给客户端。
